---
title: "animate cc eov"
author: "Dana K Briscoe"
date: '`r Sys.Date()`'
output: html_document
params:
  eov: "sst"
  enddate: !r Sys.Date() - 2
  startdate: !r Sys.Date() - 32
  timestep: "weekly"
  nc_path: "/Users/briscoedk/dbriscoe@stanford.edu - Google Drive/My Drive/ncdf/npac"
  bbox: !r tibble::tibble(ymin=25, ymax=50,xmin=-165, xmax=-110)
  cclme: TRUE
  tcms: TRUE
  bathy: TRUE
  plot_text_size: 12
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = FALSE,
    eval = TRUE,
    message = FALSE,
    warning = FALSE #,
    # dpi = 300,
    # fig.align = "center",
    # fig.height = 9
    )

# See Options: knitr::opts_chunk$get()
```

```{r load-libraries}
library(tidyverse)
library(data.table)
library(sp)
library(sf)
library(gganimate)
library(ggmap)
library(dplyr)
library(magrittr)
library(magick)
library(raster)
library(oce)
library(RColorBrewer)
library(rnaturalearth)
library(gifski)

```

```{r source-helper-funcs}
## Source helper functions
source('00_automate_EOV_helper_functions.R')
source('crop_image.R')
```


## Load CC Data
```{r load-raw-cc-data}
## Pull Raw Tracking Data -----
files <- list.files('~/Downloads/batch/', pattern = "All.csv", recursive=T, full.names=T)

raw_data <- rbindlist(lapply(files, fread)) %>%
    dplyr::select('Platform ID No.', 'Latitude', 'Longitude', 'Loc. quality', 'Loc. date') %>%
    rename(id = 1,
           lat = 2,
           lon = 3,
           loc_quality = 4,
           date = 5
    ) %>%
    mutate(date = as.POSIXct(date, format= "%m/%d/%Y %H:%M:%S", tz="UTC")) %>%
    filter(lat > 0 & lat < 60) %>%
    filter(date >= '2023-07-11 04:30:00')

```


## Prep CC Data
```{r create-cc-daily-avgs}
# create daily cc avgs
daily_avg_data <- raw_data %>%
    mutate(date = as.Date(date)) %>%
    group_by(id, date) %>%
    summarise(lat = mean(lat),
              lon = mean(lon))
```


```{r prep-turtle-sp}
turtlesgeo <- prep_turtles_sp(df = daily_avg_data)

```


## Load EOV Data
```{r set-param-ncpath}
# Set param to run
if(params$eov == 'sst'){
    nc_path <- "/Users/briscoedk/dbriscoe@stanford.edu - Google Drive/My Drive/ncdf/deploy_reports"
    params$varname <- "sst_dhw_5km"
} else if (params$eov == "ssta"){
    nc_path <- "/Users/briscoedk/dbriscoe@stanford.edu - Google Drive/My Drive/ncdf/npac"
    params$varname <- "ssta_dhw_5km"
} else if (params$eov == "chlaWeekly"){
    nc_path <- "/Users/briscoedk/dbriscoe@stanford.edu - Google Drive/My Drive/ncdf/npac"
    params$varname <- "chlaWeekly" 
} 

```

```{r get-ncdf-list}
# get ncdf list

ncs <- list.files(nc_path, pattern = params$varname, full.names=T)
print(str_c('most recent ncdf - ', ncs[length(ncs)]))

```

```{r get-nc-fdates}
fdates <- get_ncdf_fdates(x = params$eov, ncs)

```


```{r get-cc-eov-date-intersection}
# get dates that match track dates
tracking_dates <- unique(daily_avg_data$date)
eov_dates <- as.Date(unique(fdates))
deploy_date <- as.Date("2023-07-10")

daily_dates <- intersect(as.character(tracking_dates), as.character(eov_dates))
```


```{r load-intersecting-ncdfs}
# get files
ncIn <- sapply(1:length(daily_dates), function(x) ncs[grepl(daily_dates[x],ncs)])

# convert ncs to raster stack
ras <- {suppressWarnings(raster::stack(ncIn))}

```


## Prep EOV Data
### Prep / Crop Rasters
```{r assign-ras-date-names}
# reassign ras names according to intersecting cc-eov dates (assuming n lengths differ)
if(length(fdates) != length(ncIn)){

    if(params$eov == 'sst'){
        nc_dates <- ncIn %>% 
            map(~parseDT(., idx = 6, start=13, stop = 22, format="%Y-%m-%d")) %>%
            unlist() %>% as.Date() #%>%
    } else if (params$eov == 'chlaWeekly'){
        nc_dates <- ncIn %>% 
            map(~parseDT(., idx = 6, start=28, stop = 38, format="%Y-%m-%d")) %>%
            unlist() %>% as.Date() #%>%
    } else if(params$eov == 'ssta'){
        nc_dates <- ncIn %>% 
            map(~parseDT(., idx = 6, start=14, stop = 23, format="%Y-%m-%d")) %>%
            unlist() %>% as.Date() #%>%
    }
    
    names(ras) <- nc_dates

} else {
    # names(ras) <- fdates
    print('confirm fdates')
}

```

```{r set-spatial-extents}
e180 <- extent(params$bbox[['xmin']], params$bbox[['xmax']], params$bbox[['ymin']], params$bbox[['ymax']])
# e360 <- extent(make360(e[1]), make360(e[2]), e[3], e[4])   

```

```{r crop-ras-extent}
ras_subset <- crop(ras, e180) 
```

### GoC Mask
```{r mask-GoC}
# create goc mask
goc_mask <- rbind(c(-110, 23.75), c(-122, 40), c(-110, 40), c(-110, 23.75))
goc_mask <- SpatialPolygons(list(Polygons(list(Polygon(goc_mask)), 1)))

# mask raster stack
ras_masked <- mask(ras_subset, goc_mask, inverse=T)
```

### Ras to DF
```{r convert-ras-to-df}

eov_df <- ras_masked %>%
    ras2df()

```


## Prep Plots
### Prep CC-EOV DFs

```{r create-turtles-df}
turtles_df <- turtlesgeo %>% filter(date %in% nc_dates)
```


```{r calc-df-timesteps}
if(params$timestep == 'daily'){
    # keep daily avgs and filter last 1 month for anim
    turtles_df <- turtles_df %>%
        filter(date >= params$startdate & params$enddate)
    
    eov_df <- eov_df %>%
        filter(date >= params$startdate & params$enddate)
    
} else if(params$timestep == 'weekly'){
    # convert daily avgs to weekly dates for anim
    turtles_df_weekly <- turtles_df %>%
        mutate(start_of_week = floor_date(date, "week") %>% as.Date(.)) %>%
        group_by(start_of_week, id) %>%
        summarize(lat = mean(lat, na.rm = TRUE),
                  lon = mean(lon, na.rm = TRUE), .groups = "drop") %>%
        rename('date' = 'start_of_week')
    
    eov_df_weekly <- eov_df %>%
        mutate(start_of_week = floor_date(date, "week") %>% as.Date(.)) %>%
        group_by(start_of_week, x, y) %>%
        summarize(val = mean(val, na.rm = TRUE), .groups = "drop") %>%
        rename('date' = 'start_of_week')

}

```

### Set EOV CBAR Params
```{r set-eov-cbar-params}

if(params$eov == 'sst'){
    
    limits = c(5,35)
    
    # goc masked
    cbar_breaks = seq(4, 30, 1)
    cbar_limits = c(4, 31)
    # cbar_limits <- c(6,31)
    cbar_int <- 1
    cbar_title <- 'SST (°C) \n'
    
    tzcf_contour = 18
    tzcf_color = 'white'
        
    tcms_color = "#FFFCF2"
    
    smooth_rainbow <- khroma::colour("smooth rainbow")

    cpal <- c(smooth_rainbow(length(seq(floor(limits[1]), ceiling(limits[2]), 1)), range = c(0, 0.9)), "#9e2a2b", "firebrick4")
    
    zCuts <- seq(4,34,1)
    
} else if(params$eov == 'ssta'){
    
    # limits = c(5,35)
    
    tzcf_contour <- NA
    tzcf_color = NA
    
    tcms_color = "gray40"
    
    cbar_breaks <- seq(-5.5,6,0.5)
    cbar_limits <- c(-5.5,6)
    cbar_int <- 0.5
    cbar_title <- 'SST (°C)\n'

    cpal <- rev(c("#48090B", "#540b0e", rev(brewer.pal(9, "YlOrRd")),"white", brewer.pal(9, "Blues"), "#06224C", "#031126", "#020813"))
    
    zCuts <- seq(-5.5,6,0.5)
    
} else if(params$eov == 'chlaWeekly'){

    cbar_breaks <- c(0.2, 2, 10, 20)
    cbar_limits <- limits <- c(0,20)
    cbar_int <- 0.1
    cbar_title <- 'Chl \n(mg/m^3) \n'
    
    tzcf_contour = NA #0.2
    tzcf_color = NA #'gray10'
    
    tcms_color = "#FFFCF2"
        
    smooth_rainbow <- khroma::colour("smooth rainbow")

    cpal <- c(smooth_rainbow(length(seq(floor(limits[1]), ceiling(limits[2]), 1)), range = c(0, 0.9)), "#9e2a2b", "firebrick4")

    zCuts <- seq(0,20,1)
}

```

### Get Map Elements
```{r get-map-elements}
# add map elements

## continents
mapdata <- get_mapdata()

## etopo bathy
bathy_df <- get_bathy_df()

## cclme shapefile
cclme_df <- get_cclme_df()

## us state boundaries
usa <- get_state_borders()

```

```{r assign-cohort1-release-loc}
release_loc = data.frame(lat=39.315, lon=213.9333)
```


### Assign GG Layers
```{r make-gglayers}

add_baseplot <- function(bbox = params$bbox){
    list(
    # add land
    geom_polygon(data = mapdata, aes(x=long, y = lat, group = group), color = "black", fill = "black"),

    # theme
    theme_minimal(), 
    theme(
        text = element_text(size=12),
        plot.title = element_text(size=14, face="bold", margin=margin(t=20,b=0), hjust=0.03),
        # plot.subtitle = element_text(size = 14, face="bold", margin=margin(t=30,b=-30), hjust=0.025, color=subtitle_text_col),
        plot.caption = element_text(size=10.5),
        legend.key = element_rect(color="snow", fill = 'white'), legend.key.size=unit(13,"point"),
        plot.margin = unit(c(0.75, 0, 0.5, 0), "cm")
    ),

    # set map extent
    coord_sf(xlim = c(make360(bbox$xmin+1), make360(bbox$xmax)), ylim = c(bbox$ymin, bbox$ymax), expand = FALSE, crs = st_crs(4326)), 
    
    # labs
    labs(x = "\n Longitude \n", y = "\n \n Latitude \n ") #,
        # theme(plot.subtitle = element_text(size = 14, face="bold", margin=margin(t=30,b=-30), hjust=0.025, color=subtitle_text_col)),
        # labs(subtitle = str_c("Week of: ", format(dates[i], "%b-%d-%Y")))

    )
}


add_bathy <- function(data = bathy_df, depths = c(-140, -500), cols = c("azure3", "azure4")){
    list(
    geom_contour(data=data, aes(x=make360(long), y=lat, z = z), colour = cols[1], linewidth = 0.75,
                 breaks = c(depths[1])),
        geom_contour(data=data, aes(x=make360(long), y=lat, z = z), colour = cols[2], linewidth = 0.75,
                     breaks = c(depths[2]))
    )
}

add_cclme <- function(data = cclme_df){
    list(
         geom_polygon(data = data, aes(x = make360(long), y = lat.x, group = group), fill = 'gray85', alpha = 0.5) 
    )
}

add_tcms_box <- function(tcms_color = "white"){
    list(
         geom_rect(aes(xmin=225,xmax=243,ymin=25.25,ymax=35), colour=tcms_color,alpha=0, size=0.65) 
    )
}

add_tzcf_contour <- function(data = eov_df, tzcf_color, tzcf_contour){
    list(
     # add tzcf contour
    geom_contour(data=data, aes(x=x, y=y, z = val), colour = tzcf_color, linewidth = 1.25,
                 breaks = c(tzcf_contour)) 
    )
    
}

add_state_borders <- function(data = usa_360){
    list(
        geom_sf(data = usa_360, color = "snow", fill = "black", size=0.5)
    )
}

```


### Assign Plot Titles
```{r assign-plot-titles}

if(params$eov == 'sst'){
    title_eov <- 'sea surface temperature (SST)'
    subtitle_text_col <- 'snow'
        caption_iso <- 'The white line represents the 18°C isotherm. '
        eov_source <- 'NOAA Coral Reef Watch 5km Daily SST'
} else if(params$eov == 'chlaWeekly'){
    title_eov <- 'chlorophyll-a (Chl)'
    subtitle_text_col <- 'gray8'
        caption_iso <- '' #'The 0.2 mg/m^3 isopleth (black line) represents the approximate TZCF position in the eastern North Pacific. '
        eov_source <- 'VIIRS Near Real-Time, DINEOF Gap-Filled 9km Daily Chl Concentration'
} else if(params$eov == 'current'){
    title_eov <- 'surface current flow'
    subtitle_text_col <- 'gray8'
        caption_iso <- 'The 0.2 mg/m^3 isopleth (black line) represents the approximate TZCF position in the eastern North Pacific. '
        eov_source <- 'Calculated from Near Real-Time Geostrohic Current (u, v) 0.2 degrees spatial res, Daily'
} else if(params$eov == 'ssta'){
    title_eov <- 'sea surface temperature anomaly (SSTA)'
    subtitle_text_col <- 'gray8'
    caption_iso <- ''
    eov_source <- 'NOAA Coral Reef Watch 5km Daily SSTA'
}

```


## PICK UP HERE!!! SET DAILY OR WEEKLY INPUTS!
```{r}

## use image magick
library(lubridate)
dates <- seq(as.Date("2023-07-16"), as.Date("2023-12-24"), by = "weeks")
# dates <- seq(as.Date(min(turtles_df_weekly$date)), as.Date(max(turtles_df_weekly$date)-1), by = "weeks") # assumes using end of week: week -1
dates <- seq(as.Date(min(turtles_df_weekly$date)), as.Date(max(turtles_df_weekly$date)), by = "weeks") # assumes start of week

n = length(dates)

```

